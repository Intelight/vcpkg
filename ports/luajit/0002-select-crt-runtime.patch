From 4bf3fef6711a96b5410f4419ea3fdcee5216b756 Mon Sep 17 00:00:00 2001
From: Doug Crawford <doug.crawford@intelight-its.com>
Date: Fri, 13 Jan 2017 16:08:25 -0700
Subject: [PATCH] choose static or dynamic crt runtime

---
 0001-force-visual-studio-14-vcvarsall.patch | 25 +++++++++++++++++++++++++
 src/msvcbuild.bat                           |  7 ++++---
 2 files changed, 29 insertions(+), 3 deletions(-)
 create mode 100644 0001-force-visual-studio-14-vcvarsall.patch

diff --git a/0001-force-visual-studio-14-vcvarsall.patch b/0001-force-visual-studio-14-vcvarsall.patch
new file mode 100644
index 0000000..275315a
--- /dev/null
+++ b/0001-force-visual-studio-14-vcvarsall.patch
@@ -0,0 +1,25 @@
+From 7fa4121a6fb4dbdd5f7f7ec2b99b3d6c02cbedb0 Mon Sep 17 00:00:00 2001
+From: Doug Crawford <doug.crawford@intelight-its.com>
+Date: Fri, 13 Jan 2017 16:05:29 -0700
+Subject: [PATCH] force visual studio 14 vcvarsall
+
+---
+ src/msvcbuild.bat | 2 ++
+ 1 file changed, 2 insertions(+)
+
+diff --git a/src/msvcbuild.bat b/src/msvcbuild.bat
+index 4b50185..1d77460 100644
+--- a/src/msvcbuild.bat
++++ b/src/msvcbuild.bat
+@@ -13,6 +13,8 @@
+ 
+ @if not defined INCLUDE goto :FAIL
+ 
++call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" x86
++
+ @setlocal
+ @set LJCOMPILE=cl /nologo /c /O2 /W3 /D_CRT_SECURE_NO_DEPRECATE
+ @set LJLINK=link /nologo
+-- 
+2.10.2.windows.1
+
diff --git a/src/msvcbuild.bat b/src/msvcbuild.bat
index 1d77460..b826cd2 100644
--- a/src/msvcbuild.bat
+++ b/src/msvcbuild.bat
@@ -69,22 +69,23 @@ buildvm -m folddef -o lj_folddef.h lj_opt_fold.c
 @shift
 @set LJCOMPILE=%LJCOMPILE% /Zi
 @set LJLINK=%LJLINK% /debug
+@set CRTSUFFIX=d
 :NODEBUG
 @if "%1"=="amalg" goto :AMALGDLL
 @if "%1"=="static" goto :STATIC
-%LJCOMPILE% /MD /DLUA_BUILD_AS_DLL lj_*.c lib_*.c
+%LJCOMPILE% /MD%CRTSUFFIX% /DLUA_BUILD_AS_DLL lj_*.c lib_*.c
 @if errorlevel 1 goto :BAD
 %LJLINK% /DLL /out:%LJDLLNAME% lj_*.obj lib_*.obj
 @if errorlevel 1 goto :BAD
 @goto :MTDLL
 :STATIC
-%LJCOMPILE% lj_*.c lib_*.c
+%LJCOMPILE% /MT%CRTSUFFIX% lj_*.c lib_*.c
 @if errorlevel 1 goto :BAD
 %LJLIB% /OUT:%LJLIBNAME% lj_*.obj lib_*.obj
 @if errorlevel 1 goto :BAD
 @goto :MTDLL
 :AMALGDLL
-%LJCOMPILE% /MD /DLUA_BUILD_AS_DLL ljamalg.c
+%LJCOMPILE% /MD%CRTSUFFIX% /DLUA_BUILD_AS_DLL ljamalg.c
 @if errorlevel 1 goto :BAD
 %LJLINK% /DLL /out:%LJDLLNAME% ljamalg.obj lj_vm.obj
 @if errorlevel 1 goto :BAD
-- 
2.10.2.windows.1

